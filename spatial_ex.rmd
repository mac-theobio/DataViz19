---
title: "spatial examples
author: "Alex Bushby, Aleks Jovic, Ben Bolker"
---

```{r pkgs,message=FALSE}
library(ggmap)
library(tidyverse)
library(viridis)
load("data/googlemaps.rda")
```

# crime

The `crime` dataset contains crime reports for Houston from January-August 2010, geocoded with Google Maps.

```{showcrime}
tibble(crime)
```
Lots of useful info: dates, types of crimes, locations by type of place, locations by street, locations by longitude/latitude ...

First, let’s get an overview of the crimes on the map. Using qmplot, we put in longitude and latitude for the x, and y parameters, and specify the data as the crime dataset. This plots the crimes indiscriminantly.

[original code](https://github.com/tidyverse/ggplot2/wiki/crime-in-downtown-houston,-texas-:-combining-ggplot2-and-google-maps)
```{r message=FALSE}
q1 <- qmplot(lon, lat, data = crime,
       maptype = "toner-lite", colour = I("red"), size = I(0.9),alpha=I(.3))
```

Or

```{r}
get_mapzone <- function(data, latcol="lat", loncol="lon") {
  lon <- na.omit(data[[loncol]])
  lat <- na.omit(data[[latcol]])
  return(c(left=min(lon),right=max(lon),bottom=min(lat),top=max(lat)))
}
houston_mz <- get_mapzone(crime)
houston_map1 <- get_stamenmap(houston_mz,zoom=7, maptype="toner-lite")
(ggmap(houston_map1)
  + geom_point(data=crime,colour="red",size=0.9,alpha=0.3)
)
```


Reduce crime to violent crimes in downtown Houston:

```{r}
violent_crime <-
  (crime
    %>% filter(
          !offense %in% c("auto theft", "theft", "burglary"),
          -95.39681 <= lon & lon <= -95.34188,
          29.73631 <= lat & lat <=  29.78400
        )
    %>% mutate(
          ## drops unused levels, mitigates downstream errors
          offense = fct_drop(offense), 
          offense = fct_relevel(offense,
               c("robbery", "aggravated assault", "rape", "murder")
               )
        )
  )
```


```{r}
houston_map2 <- get_stamenmap(get_mapzone(violent_crime), maptype="toner-lite",
                              zoom=14)
(ggmap(houston_map2)
  + geom_point(data = violent_crime, colour = "red",size = 0.9, alpha=.3)
)
```

```{r}
(ggmap(houston_map2)
  + geom_density2d(data = violent_crime, aes(x=lon,y=lat), col="red")
)
```

```{r}
(ggmap(houston_map2)
  + geom_bin2d(data = violent_crime, alpha=0.5)
  + scale_fill_gradient(low="#F0F0FF", high="#131393",
                        trans=scales::log10_trans())
)
```

## Heatmap

To make the contour map more useful, we can assign a gradient. Let’s look at the robberies:

```{r}
houston_map3 <- get_stamenmap(get_mapzone(violent_crime),
                              maptype="toner-background",
                              zoom=14)
```

```{r}
robbery <- violent_crime %>% filter(offense=='robbery')
(ggmap(houston_map3)
  + stat_density_2d(data=robbery,
                    aes(fill = ..level..), geom = "polygon",
                    alpha = .35, colour = NA)
  + scale_fill_gradient2("Robbery\nHeatmap",
                         low = "white", mid = "yellow",
                         high = "red", midpoint = 650)
)
```

```{r}
(ggmap(houston_map3,darken=c(0.9,"white"))
  + geom_point(data = violent_crime, aes(colour = offense, size=offense)) + 
  facet_wrap(~ offense)+
  scale_colour_brewer(palette="Dark2")+
  scale_size_manual(values=c(1,1,2,3))+
  theme(legend.position="none")
)
```
