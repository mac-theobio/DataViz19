<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title>diagnostic graphics</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <link rel="stylesheet" href="main.css" type="text/css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS_CHTML-full" type="text/javascript"></script>
</head>
<body>
<header class="site-header">
<div class="wrapper">
	<h1 class="title">
		<a href="index.html">Biology 744, McMaster University</a>
	</h1>
	<div style="text-align:center">
		<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/29/Minard.png/640px-Minard.png" width=80%>
	</div>
</div>
</header>
<div id="header">
<h1 class="title">diagnostic graphics</h1>
</div>
<!-- 
apa.csl is a slightly hacked version of APA 
  (modified for "et al" after 2 authors in text)
-->
<!-- .refs is style for reference page (small text) -->
<style>
.refs {
   font-size: 16px;
}
h2 { 
 color: #3399ff;        
}
h3 { 
 color: #3399ff;        
}
.title-slide {
   background-color: #55bbff;
}
</style>
<!--    content: url(https://i.creativecommons.org/l/by-sa/4.0/88x31.png)
>
<!-- Limit image width and height -->
<style type="text/css">
img {     
  max-height: 530px;     
  max-width: 800px; 
}
</style>
<h2 id="packages">Packages</h2>
<pre><code>library(tidyverse)
theme_set(theme_bw())
library(car)
library(broom)
library(broom.mixed)
library(magrittr)
## modeling
library(lme4)
library(MCMCglmm)
library(glmmTMB)
library(coda) ## Bayesian methods (trace plots etc.)
library(lattice) ## built-in
library(cowplot)
library(nullabor) ## visual inference</code></pre>
<h2 id="diagnostics-goals-and-ideas">Diagnostics: goals and ideas</h2>
<ul>
<li>detect model failure</li>
<li>display badness of fit</li>
<li>fast/convenient</li>
<li>residuals emphasize deviation, hide fitted pattern</li>
</ul>
<h2 id="diagnostics-principles">Diagnostics: principles</h2>
<ul>
<li>diagnosis is exploration</li>
<li>avoid making decisions based on p-values</li>
<li>judge by eye (?¿?¿?¿?¿)</li>
<li><strong>not</strong> “are my data (linear|normal|heteroscedastic)?”;<br />
rather, <em>“how much do the violations change my conclusions?”</em></li>
</ul>
<h2 id="diagnostics-after-fitting-model">diagnostics <em>after</em> fitting model</h2>
<ul>
<li>Interested in <em>conditional</em>, not <em>marginal</em> values</li>
<li>What does this mean?</li>
</ul>
<p><img src="diagnostics_files/figure-markdown_strict/marginal1-1.png" /></p>
<h2 id="marginal-distributions">marginal distributions</h2>
<p><img src="diagnostics_files/figure-markdown_strict/marginal_hist-1.png" /></p>
<h2 id="quantile-plots">quantile plots</h2>
<pre><code>m0 &lt;- lm(y~x,dd)
a0 &lt;- (augment(m0)
  %&gt;% select(x,y,.resid)
  %&gt;% gather(type,value)
  %&gt;% mutate(type=factor(type,levels=c(&quot;x&quot;,&quot;y&quot;,&quot;.resid&quot;)))
)</code></pre>
<hr />
<pre><code>(ggplot(a0,aes(sample=value))
  + stat_qq()
  + facet_wrap(~type)
  + stat_qq_line(colour=&quot;red&quot;)
)</code></pre>
<p><img src="diagnostics_files/figure-markdown_strict/q2B-1.png" /></p>
<h2 id="model-diagnosis">model diagnosis</h2>
<p>look for <em>mis-specification</em> (in order!):</p>
<ul>
<li>mean model (bias)</li>
<li>variance model (heteroscedasticity)</li>
<li>distributional model (e.g. non-normality)</li>
</ul>
<p>influential points/groups (leverage/outliers/etc.)</p>
<p>upstream problems affect downstream diagnostics</p>
<h2 id="bias">bias</h2>
<p style="font-size:16px">
<pre><code>m1 &lt;- lm(price~carat,diamonds)
a1 &lt;- augment(m1,data=diamonds) ## include original data
ggplot(a1,aes(.fitted,.resid)) +
    geom_point(alpha=0.1)+geom_smooth()</code></pre>
<img src="diagnostics_files/figure-markdown_strict/fitres1-1.png" />
</p>
<h2 id="bias-2-facetingcolouring">bias 2: faceting/colouring</h2>
<pre><code>ggplot(a1,aes(.fitted,.resid,colour=cut)) +
    facet_wrap(~clarity) +
    geom_point(alpha=0.4)+geom_smooth()</code></pre>
<p><img src="diagnostics_files/figure-markdown_strict/fitres2-1.png" /></p>
<p>useful to use dynamic graphics <code>ggmap::gglocator</code> (may need <code>devtools::install_github("dkahle/ggmap")</code>)</p>
<h2 id="solutions-to-bias">solutions to bias</h2>
<ul>
<li>fix the model</li>
<li>add covariates and interactions</li>
<li>transform predictors and/or responses (<code>acepack::avas</code>, Tibshirani (1987))</li>
<li>nonlinear terms
<ul>
<li>polynomials</li>
<li>splines (regular or penalized)</li>
<li>‘real’ nonlinearity</li>
</ul></li>
</ul>
<h2 id="heteroscedasticity">heteroscedasticity</h2>
<ul>
<li>linear models
<ul>
<li>loss of efficiency (linear fit is still MVUE)</li>
<li>inferential problems (Quinn and Keough (2002) p. 193)</li>
</ul></li>
<li>nonlinear models
<ul>
<li>bias</li>
</ul></li>
</ul>
<h2 id="heteroscedasticity-diagnostics">heteroscedasticity diagnostics</h2>
<ul>
<li>scale-location plot</li>
<li>use <span class="math inline">\(\\sqrt{|r\_i|}\)</span>:
<ul>
<li>absolute value shows trend</li>
<li>square root decreases skewness</li>
</ul></li>
<li><p>use standardized residuals<br />
(adjust variance for position)</p>
<p>m2 &lt;- lm(dist ~ speed, data=cars) ggplot(augment(m2),aes(.fitted,sqrt(abs(.std.resid))))+ geom_point()+geom_smooth()</p></li>
</ul>
<p><img src="diagnostics_files/figure-markdown_strict/heterosced-1.png" /></p>
<h2 id="heteroscedasticity-solutions">heteroscedasticity solutions</h2>
<ul>
<li>transformation (Tibshirani 1987)</li>
<li>explicitly model heteroscedasticity<br />
e.g. generalized least squares, GLMs</li>
<li>robust variance-covariance estimation<br />
(e.g. <code>sandwich</code> package: Zeileis (2006))</li>
</ul>
<h2 id="distributional-assumptions">distributional assumptions</h2>
<ul>
<li>least important</li>
<li>quantile-quantile plots</li>
</ul>
<h2 id="histograms">histograms</h2>
<p><img src="diagnostics_files/figure-markdown_strict/hist-1.png" /></p>
<h2 id="quantile-plots-1">quantile plots</h2>
<ul>
<li>ggplot: <code>stat_qq()</code>, <code>stat_qq_line()</code></li>
<li>base R: <code>plot.lm(.,which=3)</code>; <code>qqnorm()</code></li>
<li><code>car::qqPlot</code> (adds confidence envelope)</li>
</ul>
<p><img src="diagnostics_files/figure-markdown_strict/qq-1.png" /></p>
<h2 id="distributional-solutions">distributional solutions</h2>
<ul>
<li>transformation (<code>avas</code>, Box-Cox (<code>MASS:boxcox</code>), Yeo-Johnson etc. <span class="math display">\[`?car::bcPower`\]</span>)</li>
<li>GLMs</li>
<li>maximum likelihood estimation</li>
</ul>
<h2 id="correlation">correlation</h2>
<p>rarely tested! can’t detect without some kind of structure in data</p>
<ul>
<li>autocorrelation plots from residuals</li>
<li>grouped autocorrelation: use <code>gls()</code> on residuals</li>
<li>spatial autocorrelation: semivariance plot</li>
<li>or look at maps of residuals with <code>size=abs(.resid)</code>, <code>colour=sign(.resid)</code> (or colour ramp)</li>
</ul>
<h2 id="binary-data">binary data</h2>
<ul>
<li>residuals for count data only ≈ Normal for large counts</li>
<li>add smooths or average of grouped data</li>
</ul>
<p>Fit:</p>
<pre><code>library(lme4)
data(Contraception,package=&quot;mlmRev&quot;)
Contraception &lt;- Contraception %&gt;%
    mutate(ch=factor(livch != 0, labels = c(&quot;N&quot;, &quot;Y&quot;)))
m3 &lt;- glmer(use ~ age * ch + I(age^2) + urban + (1 | urban:district),
            data=Contraception, family=binomial)</code></pre>
<h2 id="plot">plot</h2>
<pre><code>a3 &lt;- augment(m3,data=Contraception,type.residuals=&quot;response&quot;)
gg_bin1 &lt;- (ggplot(a3,aes(.fitted,.resid))+
            geom_point()+ geom_smooth(method=&quot;loess&quot;))
print(gg_bin1)</code></pre>
<p><img src="diagnostics_files/figure-markdown_strict/binary_smooth_plot1-1.png" /></p>
<h2 id="grouping">grouping</h2>
<pre><code>get_mid &lt;- function(x) {
    cc &lt;- as.character(x)
    lo &lt;- as.numeric(gsub(&quot;[\\(\\[]([[:digit:].-]+).*&quot;,&quot;\\1&quot;,cc))
    hi &lt;- as.numeric(gsub(&quot;.*,([[:digit:].-]+)[])]&quot;,&quot;\\1&quot;,cc))
    return((lo+hi)/2)
}
(a3
    %&gt;% mutate(.fit_cut=cut_number(.fitted,20))
    %&gt;% group_by(.fit_cut)
    %&gt;% summarise(.resid=mean(.resid))
    %&gt;% ungroup
    %&gt;% mutate(.fitted=get_mid(.fit_cut))
) -&gt; a3_sum</code></pre>
<h2 id="plot-with-grouping">plot with grouping</h2>
<pre><code>gg_bin1+geom_point(data=a3_sum,colour=&quot;blue&quot;)</code></pre>
<p><img src="diagnostics_files/figure-markdown_strict/binary_smooth_plot-1.png" /></p>
<pre><code>ggplot(a3,aes(.fitted,.resid,colour=livch,shape=urban,linetype=urban))+
            geom_point()+ geom_smooth(se=FALSE)+
    scale_colour_brewer(palette=&quot;Dark2&quot;)

## `geom_smooth()` using method = &#39;loess&#39; and formula &#39;y ~ x&#39;</code></pre>
<p><img src="diagnostics_files/figure-markdown_strict/binary2-1.png" /></p>
<h2 id="keep-trying">keep trying …</h2>
<pre><code>ggplot(a3,aes(age,.resid,colour=urban))+
    geom_point()+
    geom_smooth(method=&quot;loess&quot;)+
    facet_wrap(~livch)</code></pre>
<p><img src="diagnostics_files/figure-markdown_strict/binary3-1.png" /></p>
<ul>
<li><p>loess too bumpy?</p>
<p>ggplot(a3,aes(age,.resid,colour=urban))+ geom_point()+ geom_smooth(method=“loess”, method.args=list(family=“symmetric”),span=1)+ facet_wrap(~livch)</p></li>
</ul>
<p><img src="diagnostics_files/figure-markdown_strict/binary4-1.png" /></p>
<ul>
<li>try <code>method="gam"</code> ?</li>
</ul>
<!-- -->
<pre><code>ggplot(a3,aes(age,.resid,colour=urban))+
    geom_point()+
    geom_smooth(method=&quot;gam&quot;,formula =y ~ s(x, k=25)) +
    facet_wrap(~livch)</code></pre>
<p><img src="diagnostics_files/figure-markdown_strict/binary_gam-1.png" /></p>
<ul>
<li>note: <code>qq.gam()</code> (Augustin, Sauleau, and Wood 2012)</li>
<li>improved QQ for GLMs (only for fits via <code>mgcv::gam()</code> ?)</li>
<li>binary data still problematic: from <code>?qq.gam</code>,</li>
</ul>
<blockquote>
<p>Note that plots for raw residuals from fits to binary data contain almost no useful information about model fit. Whether the residual is negative or positive is decided by whether the response is zero or one. The magnitude of the residual, given its sign, is determined entirely by the fitted values. In consequence only the most gross violations of the model are detectable from QQ-plots of residuals for binary data. To really check distributional assumptions from residuals for binary data you have to be able to group the data somehow. Binomial models other than binary are ok.</p>
</blockquote>
<h2 id="coverage">coverage</h2>
<p><img src="pix/glycera_pvals.png" /></p>
<h2 id="likelihood-profiles">likelihood profiles</h2>
<p>use <span class="math inline">\(\\sqrt{-2 \\log (L-L\_0)}\)</span> (<span class="math inline">\(\\sf V\)</span>-shaped), signed square root (straight line/symmetry)</p>
<p><img src="diagnostics_files/figure-markdown_strict/profile_plot-1.png" /></p>
<h2 id="mcmc">MCMC</h2>
<ul>
<li>trace plots - should look like white noise, with no trend …</li>
</ul>
<!-- -->
<pre><code>lattice::xyplot(m4$Sol,aspect=&quot;fill&quot;,layout=c(2,3))</code></pre>
<p><img src="diagnostics_files/figure-markdown_strict/trace-1.png" /></p>
<ul>
<li>trace plots</li>
</ul>
<h2 id="posterior-predictive-plots">posterior predictive plots</h2>
<pre><code>set.seed(101); nsim &lt;- 1e4
owls_sim &lt;- simulate(owls_nb1,nsim)
sumfun &lt;- function(x)sum(x==0)
zero_vals &lt;- apply(owls_sim,2,sumfun)
dz &lt;- as.data.frame(table(zero_vals)/nsim) %&gt;%
    mutate(zero_vals=as.numeric(zero_vals))
obsval &lt;- sumfun(Owls$SiblingNegotiation)
gsim &lt;- ggplot(dz,aes(zero_vals,Freq))+geom_point()+
    geom_segment(aes(xend=zero_vals,yend=0))+
    geom_vline(xintercept=obsval,col=&quot;red&quot;)+
    annotate(geom=&quot;text&quot;,x=obsval,y=0.03,label=&quot;observed&quot;,
             col=&quot;red&quot;,hjust=1.1)</code></pre>
<p><img src="diagnostics_files/figure-markdown_strict/gsimplot-1.png" /></p>
<h2 id="complex-models-wickham-et-al.-2010-gelman-2004-buja-et-al.-2009">complex models (Wickham et al. 2010; Gelman 2004; Buja et al. 2009)</h2>
<pre><code>simdat &lt;- (simulate(m2,8)
    %&gt;% data.frame(speed=cars$speed)
    %&gt;% gather(sample,dist,-speed))
ddsim &lt;- (cars
    %&gt;% select(dist,speed)
    %&gt;% mutate(sample=&quot;true&quot;)
    %&gt;% bind_rows(simdat))
ddsimplot &lt;- ggplot(ddsim,aes(speed,dist))+geom_point()+
    facet_wrap(~sample)</code></pre>
<p><img src="diagnostics_files/figure-markdown_strict/unnamed-chunk-2-1.png" /></p>
<h2 id="references">references</h2>
<p>Augustin, Nicole H., Erik-André Sauleau, and Simon N. Wood. 2012. “On Quantile Quantile Plots for Generalized Linear Models.” <em>Computational Statistics &amp; Data Analysis</em> 56 (8): 2404–9. <a href="https://doi.org/10.1016/j.csda.2012.01.026" class="uri">https://doi.org/10.1016/j.csda.2012.01.026</a>.</p>
<p>Buja, A., D. Cook, H. Hofmann, M. Lawrence, E.-K. Lee, D. F. Swayne, and H. Wickham. 2009. “Statistical Inference for Exploratory Data Analysis and Model Diagnostics.” <em>Philosophical Transactions of the Royal Society A: Mathematical, Physical and Engineering Sciences</em> 367 (1906): 4361–83. <a href="https://doi.org/10.1098/rsta.2009.0120" class="uri">https://doi.org/10.1098/rsta.2009.0120</a>.</p>
<p>Gelman, Andrew. 2004. “Exploratory Data Analysis for Complex Models.” <em>Journal of Computational and Graphical Statistics</em> 13 (4): 755–79. <a href="https://doi.org/10.1198/106186004X11435" class="uri">https://doi.org/10.1198/106186004X11435</a>.</p>
<p>Quinn, Gerry P., and Michael J. Keough. 2002. <em>Experimental Design and Data Analysis for Biologists</em>. Cambridge, England: Cambridge University Press.</p>
<p>Tibshirani, Rob. 1987. “Estimating Optimal Transformations for Regression.” <em>Journal of the American Statistical Association</em> 83: 394.</p>
<p>Wickham, H., D. Cook, H. Hofmann, and Andreas Buja. 2010. “Graphical Inference for Infovis.” <em>IEEE Transactions on Visualization and Computer Graphics</em> 16 (6): 973–79. <a href="https://doi.org/10.1109/TVCG.2010.161" class="uri">https://doi.org/10.1109/TVCG.2010.161</a>.</p>
<p>Zeileis, Achim. 2006. “Object-Oriented Computation of Sandwich Estimators.” <em>Journal of Statistical Software</em> 16 (9): 1–16. <a href="http://www.jstatsoft.org/v16/i09/" class="uri">http://www.jstatsoft.org/v16/i09/</a>.</p>
<div id="footer">
	<div style="text-align:center">
		<a href="index.html">Course home page</a>
	</div>
</div>
</body>
</html>
