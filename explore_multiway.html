<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title>exploring multivariate data</title>
  <style type="text/css">code{white-space: pre;}</style>
  <link rel="stylesheet" href="main.css" type="text/css" />
</head>
<body>
<header class="site-header">
<div class="wrapper">
	<h1 class="title">
		<a href="index.html">Biology 744, McMaster University</a>
	</h1>
	<div style="text-align:center">
		<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/29/Minard.png/640px-Minard.png" width=80%>
	</div>
</div>
</header>
<div id="header">
<h1 class="title">exploring multivariate data</h1>
</div>
<pre><code>library(pgmm)    ## for olives data
library(skimr)   ## for text-based summaries
library(ggplot2); theme_set(theme_bw())
library(GGally)   ## pairs plots etc.
library(corrplot) ## correlation plots
library(dplyr)    ## data manipulation
library(tidyr)
library(readr)    ## read CSV files
library(agridat)  ## agricultural data sets</code></pre>
<h2 id="smooth-curves-glm-vs-loess-vs-gam">smooth curves; (g)lm vs loess vs GAM</h2>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Local_regression">loess</a>
<ul>
<li>local polynomial regression (quadratic by default)</li>
<li>used by default for N&lt;1000</li>
<li>&quot;Somewhat anecdotally, 'loess' gives a better appearance, but is O(N^2) in memory, so does not work for larger datasets&quot;</li>
<li>increase <code>span</code> to get smoother result</li>
</ul></li>
</ul>
<h2 id="multiple-continuous-predictors-single-response">multiple continuous predictors, single response</h2>
<p>&quot;melt&quot; data to long format (<code>gather()</code>, <code>pivot_longer()</code>)</p>
<pre><code>cars_long &lt;- pivot_longer(mtcars,
                          -mpg,  ## DON&#39;T melt mpg
                          names_to=&quot;xvar&quot;,values_to=&quot;xval&quot;)
g1 &lt;- (ggplot(cars_long,aes(xval,mpg)) +
       geom_point()+
       facet_wrap(~xvar,scale=&quot;free_x&quot;)+
       geom_smooth()
)</code></pre>
<hr />
<pre><code>print(g1)  

## `geom_smooth()` using method = &#39;loess&#39; and formula &#39;y ~ x&#39;

## Warning in simpleLoess(y, x, w, span, degree = degree, parametric =
## parametric, : pseudoinverse used at -0.005

## Warning in simpleLoess(y, x, w, span, degree = degree, parametric =
## parametric, : neighborhood radius 1.005

## Warning in simpleLoess(y, x, w, span, degree = degree, parametric =
## parametric, : reciprocal condition number 0

## Warning in simpleLoess(y, x, w, span, degree = degree, parametric =
## parametric, : There are other near singularities as well. 1.01

## Warning in predLoess(object$y, object$x, newx = if
## (is.null(newdata)) object$x else if (is.data.frame(newdata))
## as.matrix(model.frame(delete.response(terms(object)), : pseudoinverse used
## at -0.005

## Warning in predLoess(object$y, object$x, newx = if
## (is.null(newdata)) object$x else if (is.data.frame(newdata))
## as.matrix(model.frame(delete.response(terms(object)), : neighborhood radius
## 1.005

## Warning in predLoess(object$y, object$x, newx = if
## (is.null(newdata)) object$x else if (is.data.frame(newdata))
## as.matrix(model.frame(delete.response(terms(object)), : reciprocal
## condition number 0

## Warning in predLoess(object$y, object$x, newx = if
## (is.null(newdata)) object$x else if (is.data.frame(newdata))
## as.matrix(model.frame(delete.response(terms(object)), : There are other
## near singularities as well. 1.01

## Warning in simpleLoess(y, x, w, span, degree = degree, parametric =
## parametric, : pseudoinverse used at 4

## Warning in simpleLoess(y, x, w, span, degree = degree, parametric =
## parametric, : neighborhood radius 2

## Warning in simpleLoess(y, x, w, span, degree = degree, parametric =
## parametric, : reciprocal condition number 1.8444e-16

## Warning in predLoess(object$y, object$x, newx = if
## (is.null(newdata)) object$x else if (is.data.frame(newdata))
## as.matrix(model.frame(delete.response(terms(object)), : pseudoinverse used
## at 4

## Warning in predLoess(object$y, object$x, newx = if
## (is.null(newdata)) object$x else if (is.data.frame(newdata))
## as.matrix(model.frame(delete.response(terms(object)), : neighborhood radius
## 2

## Warning in predLoess(object$y, object$x, newx = if
## (is.null(newdata)) object$x else if (is.data.frame(newdata))
## as.matrix(model.frame(delete.response(terms(object)), : reciprocal
## condition number 1.8444e-16

## Warning in simpleLoess(y, x, w, span, degree = degree, parametric =
## parametric, : pseudoinverse used at 3.98

## Warning in simpleLoess(y, x, w, span, degree = degree, parametric =
## parametric, : neighborhood radius 4.02

## Warning in simpleLoess(y, x, w, span, degree = degree, parametric =
## parametric, : reciprocal condition number 2.0055e-16

## Warning in simpleLoess(y, x, w, span, degree = degree, parametric =
## parametric, : There are other near singularities as well. 16.16

## Warning in predLoess(object$y, object$x, newx = if
## (is.null(newdata)) object$x else if (is.data.frame(newdata))
## as.matrix(model.frame(delete.response(terms(object)), : pseudoinverse used
## at 3.98

## Warning in predLoess(object$y, object$x, newx = if
## (is.null(newdata)) object$x else if (is.data.frame(newdata))
## as.matrix(model.frame(delete.response(terms(object)), : neighborhood radius
## 4.02

## Warning in predLoess(object$y, object$x, newx = if
## (is.null(newdata)) object$x else if (is.data.frame(newdata))
## as.matrix(model.frame(delete.response(terms(object)), : reciprocal
## condition number 2.0055e-16

## Warning in predLoess(object$y, object$x, newx = if
## (is.null(newdata)) object$x else if (is.data.frame(newdata))
## as.matrix(model.frame(delete.response(terms(object)), : There are other
## near singularities as well. 16.16

## Warning in simpleLoess(y, x, w, span, degree = degree, parametric =
## parametric, : pseudoinverse used at 2.99

## Warning in simpleLoess(y, x, w, span, degree = degree, parametric =
## parametric, : neighborhood radius 1.01

## Warning in simpleLoess(y, x, w, span, degree = degree, parametric =
## parametric, : reciprocal condition number 0

## Warning in simpleLoess(y, x, w, span, degree = degree, parametric =
## parametric, : There are other near singularities as well. 4.0401

## Warning in predLoess(object$y, object$x, newx = if
## (is.null(newdata)) object$x else if (is.data.frame(newdata))
## as.matrix(model.frame(delete.response(terms(object)), : pseudoinverse used
## at 2.99

## Warning in predLoess(object$y, object$x, newx = if
## (is.null(newdata)) object$x else if (is.data.frame(newdata))
## as.matrix(model.frame(delete.response(terms(object)), : neighborhood radius
## 1.01

## Warning in predLoess(object$y, object$x, newx = if
## (is.null(newdata)) object$x else if (is.data.frame(newdata))
## as.matrix(model.frame(delete.response(terms(object)), : reciprocal
## condition number 0

## Warning in predLoess(object$y, object$x, newx = if
## (is.null(newdata)) object$x else if (is.data.frame(newdata))
## as.matrix(model.frame(delete.response(terms(object)), : There are other
## near singularities as well. 4.0401

## Warning in simpleLoess(y, x, w, span, degree = degree, parametric =
## parametric, : pseudoinverse used at -0.005

## Warning in simpleLoess(y, x, w, span, degree = degree, parametric =
## parametric, : neighborhood radius 1.005

## Warning in simpleLoess(y, x, w, span, degree = degree, parametric =
## parametric, : reciprocal condition number 0

## Warning in simpleLoess(y, x, w, span, degree = degree, parametric =
## parametric, : There are other near singularities as well. 1.01

## Warning in predLoess(object$y, object$x, newx = if
## (is.null(newdata)) object$x else if (is.data.frame(newdata))
## as.matrix(model.frame(delete.response(terms(object)), : pseudoinverse used
## at -0.005

## Warning in predLoess(object$y, object$x, newx = if
## (is.null(newdata)) object$x else if (is.data.frame(newdata))
## as.matrix(model.frame(delete.response(terms(object)), : neighborhood radius
## 1.005

## Warning in predLoess(object$y, object$x, newx = if
## (is.null(newdata)) object$x else if (is.data.frame(newdata))
## as.matrix(model.frame(delete.response(terms(object)), : reciprocal
## condition number 0

## Warning in predLoess(object$y, object$x, newx = if
## (is.null(newdata)) object$x else if (is.data.frame(newdata))
## as.matrix(model.frame(delete.response(terms(object)), : There are other
## near singularities as well. 1.01</code></pre>
<div class="figure">
<img src="explore_multiway_files/figure-markdown_strict/g1plot-1.png" />

</div>
<h2 id="multivariate-data">multivariate data</h2>
<pre><code>data(olive,package=&quot;pgmm&quot;)
data(fisher.barley,package=&quot;agridat&quot;)</code></pre>
<p>Hints on looking for stuff:</p>
<pre><code>library(&quot;sos&quot;)
findFn(&quot;barley&quot;)      ## full-text search of CRAN
?RSiteSearch          ## similar
help.search(&quot;barley&quot;,agrep=FALSE) ## search in *installed* package</code></pre>
<p>Order data and factor-ize year:</p>
<pre><code>ff &lt;- (fisher.barley
  %&gt;% mutate(gen=reorder(gen,yield),
             env=reorder(env,yield),
             year=factor(year))
  %&gt;% arrange(gen,env)
)

gg0 &lt;- (ggplot(ff,
               aes(x=env,y=yield,colour=year,group=year))
  ## geom_boxplot(aes(x=gen,y=yield,fill=factor(year)))
  + geom_point()+geom_line()
  + facet_wrap(~gen,nrow=1)  ## 1-row layout
)
print(gg0)</code></pre>
<div class="figure">
<img src="explore_multiway_files/figure-markdown_strict/barley_basic-1.png" />

</div>
<p>Hard to see x-axis labels: try rotating? <code>coord_flip()</code> doesn't interact well with faceting (see also <code>ggstance</code>)</p>
<pre><code>gg0_h &lt;- (ggplot(ff,
               aes(y=env,x=yield,colour=year,group=year))
        ## geom_boxplot(aes(x=gen,y=yield,fill=factor(year)))
  + geom_point()
  + geom_path()
  + facet_wrap(~gen,nrow=1)
  + theme(panel.spacing=grid::unit(0,&quot;lines&quot;))
  + coord_fixed(ratio=20)
)
print(gg0_h)</code></pre>
<div class="figure">
<img src="explore_multiway_files/figure-markdown_strict/barley2-1.png" />

</div>
<p>maybe use <code>ncol=1, coord_fixed(ratio=1/20)</code>? Then yields would be aligned along the same axis (but a tall skinny plot might not be convenient)</p>
<p>Could calculate <em>differences</em> ...</p>
<pre><code>## restore names to data set 
olive_regions &lt;-
  read_csv(&quot;data/olive_regions.csv&quot;)
olive2 &lt;- 
  (full_join(olive_regions,olive,
      by=c(&quot;region_num&quot; = &quot;Region&quot;,
           &quot;area_num&quot; = &quot;Area&quot;))  
  %&gt;% select(-c(region_num,area_num))
  %&gt;% mutate_at(c(&quot;region&quot;,&quot;area&quot;),factor)
  )
colvec &lt;- c(&quot;red&quot;,&quot;blue&quot;,&quot;goldenrod&quot;)</code></pre>
<p>First a pairs plot in base R</p>
<pre><code>## define a function for panel density
panel.density &lt;- function(x, ...)
{
  usr &lt;- par(&quot;usr&quot;); on.exit(par(usr))
  par(usr = c(usr[1:2], 0, 1.5) ) ## modify y limits
  h &lt;- lapply(split(x,olive2$region),density)
  for (i in 1:length(h)) {
    lines(h[[i]]$x,h[[i]]$y/max(h[[i]]$y),col=colvec[i])
  }
}
num_cols &lt;- 3:ncol(olive2)
pairs(olive2[,num_cols],
      gap=0,     ## no spaces
      cex=0.5,   ## smaller points
      col=colvec[olive2$region],
      diag.panel=panel.density)</code></pre>
<p><img src="explore_multiway_files/figure-markdown_strict/pairs-1.png" /> This took significant hacking to get the way I wanted it! haven't adjusted the panels above the diagonal, yet ...</p>
<pre><code>## https://stackoverflow.com/questions/37889222/change-colors-in-ggpairs-now-that-params-is-deprecated
ggp1 &lt;- ggpairs(olive2,
                lower=list(continuous= function(data,mapping,...) {
                  (ggally_points(data,mapping,..., size=1)
                    + scale_colour_brewer(palette=&quot;Dark2&quot;)
                  )
                }),
                diag = list(continuous=function(data,mapping,...) {
                  (ggplot(data,mapping) 
                    + geom_density(...)
                    + scale_colour_brewer(palette=&quot;Dark2&quot;)
                  )
                }),
                upper = list(continuous=function(data,mapping, ...) {
                  (ggally_cor(data,mapping,...)
                    + scale_colour_brewer(palette=&quot;Dark2&quot;)
                  )
                }),
                columns=num_cols,
                mapping=aes(colour=region))
## https://github.com/ggobi/ggally/issues/14
theme_set(theme_bw()+ theme(panel.spacing=grid::unit(0,&quot;lines&quot;)))
print(ggp1)</code></pre>
<div class="figure">
<img src="explore_multiway_files/figure-markdown_strict/ggpairs-1.png" />

</div>
<pre><code>car::scatterplotMatrix(olive2[,num_cols],
                       groups=olive2$region,
                       gap=0)</code></pre>
<div class="figure">
<img src="explore_multiway_files/figure-markdown_strict/car-1.png" />

</div>
<p>What about just showing correlations? (Probably not &quot;exploratory&quot;.)</p>
<pre><code>library(corrplot)
corrplot(cor(olive2[,num_cols]),method=&quot;ellipse&quot;)</code></pre>
<div class="figure">
<img src="explore_multiway_files/figure-markdown_strict/corrplot-1.png" />

</div>
<pre><code>corrplot.mixed(cor(olive2[,num_cols]),lower=&quot;number&quot;,upper=&quot;ellipse&quot;)</code></pre>
<div class="figure">
<img src="explore_multiway_files/figure-markdown_strict/corrplot-2.png" />

</div>
<div id="footer">
	<div style="text-align:center">
		<a href="index.html">Course home page</a>
	</div>
</div>
</body>
</html>
